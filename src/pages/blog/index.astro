---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import { BlogList } from "@/components/react/blog-list";
import { getAuthor, type Author } from "@/data/authors";
import "@/styles/globals.css";
import type { WebSite } from "schema-dts";
import { makeJsonLd } from "@/lib/make-json-ld";
import getReadingTime from "reading-time";
import { createSearchablePost, precomputeIndex } from "@/lib/search-utils";
import { getImage } from "astro:assets";

// Get all blog posts and sort by date
const allPosts = await getCollection("blog", ({ data }) => {
  return data.draft !== true;
});

const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Create searchable posts data
let searchablePosts = sortedPosts.map((post) => {
  const readingTime = getReadingTime(post.body!).text;
  return createSearchablePost(post, readingTime);
});

// Create authors map for client
const authorsMap = sortedPosts.reduce(
  (acc, post) => {
    const author = getAuthor(post.data.author);
    if (author) {
      acc[post.data.author] = author;
    }
    return acc;
  },
  {} as Record<string, Author>
);

const images_map = Object.fromEntries(
  await Promise.all(
    searchablePosts.map(async (post): Promise<[string, string | undefined]> => {
      return [
        post.id,
        !post.data.heroImage
          ? undefined
          : (
              await getImage({
                src: post.data.heroImage,
                alt: post.data.title,
                inferSize: true,
                format: "webp",
                quality: 80,
              })
            ).src,
      ];
    })
  )
);

const blur_images_map = Object.fromEntries(
  await Promise.all(
    searchablePosts.map(async (post): Promise<[string, string | undefined]> => {
      return [
        post.id,
        !post.data.heroImage
          ? undefined
          : (
              await getImage({
                src: post.data.heroImage,
                alt: post.data.title,
                width: 20,
                height: 11,
                format: "webp",
                quality: 10,
              })
            ).src,
      ];
    })
  )
);

// Remove heroImage from searchablePosts to reduce payload and avoid frontend inability to parse ImageMetadata 
// (astro type passing to react)
searchablePosts = searchablePosts.map((post, _) => {
  post.data.heroImage = undefined;
  return post;
});

// Get unique tags for metadata
const allTags = [...new Set(sortedPosts.flatMap((post) => post.data.tags))].sort();

const fuse_index = precomputeIndex(searchablePosts);

const json_ld = makeJsonLd<WebSite>({
  "@type": "WebSite",
  "@context": "https://schema.org",
  "@id": "https://cyberpath-hq.com/",
  url: new URL("/blog", Astro.site).toString(),
  name: "CyberPath Blog",
  description: "Read our latest articles about cybersecurity, certifications, career paths, and more.",
  inLanguage: "en-US",
  author: {
    "@type": "Person",
    name: "CyberPath",
    email: "support@cyberpath-hq.com",
    description: "CyberPath is a platform dedicated to cybersecurity education and career development.",
    url: "https://cyberpath-hq.com",
  },
  image: {
    "@type": "ImageObject",
    url: new URL("/CyberPath-og.webp", Astro.site).toString(),
    width: "1920",
    height: "933",
    description: "CyberPath Blog",
  },
  datePublished: new Date(2025, 12, 29).toISOString(),
  dateModified: new Date().toISOString(),
  publisher: {
    "@type": "Person",
    name: "CyberPath",
    email: "support@cyberpath-hq.com",
    description: "CyberPath is a platform dedicated to cybersecurity education and career development.",
    url: "https://cyberpath-hq.com",
  },
});
---

<Layout
  JSON_LD={json_ld}
  seo={{
    title: "Blog - CyberPath",
    description: "Read our latest articles about cybersecurity, certifications, career paths, and more.",
    canonical: new URL("/blog", Astro.site).toString(),
    openGraph: {
      title: "Blog - CyberPath",
      description: "Read our latest articles about cybersecurity, certifications, career paths, and more.",
      type: "website" as const,
      url: new URL("/blog", Astro.site).toString(),
      images: [
        {
          url: new URL("/CyberPath-og.webp", Astro.site).toString(),
          width: 1920,
          height: 933,
          alt: "Blog - CyberPath",
        },
      ],
      site_name: "CyberPath",
    },
    additionalMetaTags: [
      {
        name: "keywords",
        content: allTags.join(", "),
      },
    ],
    twitter: {
      handle: "@cyberpath_hq",
      site: "@cyberpath_hq",
    },
  }}
>
  <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <!-- Header -->
    <header class="mb-12 text-center">
      <h1 class="mb-4 text-4xl font-extrabold tracking-tight text-foreground sm:text-5xl lg:text-6xl">Blog</h1>
      <p class="mx-auto max-w-2xl text-xl text-muted-foreground">
        Insights, tutorials, and thoughts on cybersecurity, certifications, and career development.
      </p>
      <div class="mt-6">
        <a
          href="/rss.xml"
          class="inline-flex items-center gap-2 text-sm text-muted-foreground transition-colors hover:text-primary"
          target="_blank"
          rel="noopener"
        >
          <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1Z"
            ></path>
          </svg>
          Subscribe via RSS
        </a>
      </div>
    </header>

    <!-- Client-side Blog List with Search, Filters, and Pagination -->
    <BlogList
      client:load
      posts={searchablePosts}
      authors={authorsMap}
      itemsPerPage={9}
      images={images_map}
      author_images={Object.fromEntries(
        Object.entries(authorsMap).map(([id, author]) => {
          console.log("creating author image for", id, author.avatar?.default);
          return [id, author.avatar?.default];
        })
      )}
      blur_images={blur_images_map}
      author_blur_images={Object.fromEntries(
        Object.entries(authorsMap).map(([id, author]) => {
          console.log("creating author blur image for", id, author.avatar?.blur);
          return [id, author.avatar?.blur];
        })
      )}
      index={fuse_index}
    />
  </div>
</Layout>
