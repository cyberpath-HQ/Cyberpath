---
// Mermaid diagram component
interface Props {
  code: string;
}

const { code } = Astro.props;
const id = `mermaid-${Math.random().toString(36).substr(2, 9)}`;

// Trim and normalize the code
const normalizedCode = code.trim();
---

<div class="mermaid-wrapper not-prose my-8">
  <div class="mermaid-container rounded-lg border bg-card p-2">
    <pre id={id} class="mermaid">{normalizedCode}</pre>
  </div>
</div>

<script>
  import mermaid from "mermaid";
  import Panzoom from "@panzoom/panzoom";

  // Enable pan and zoom for Mermaid diagrams
  function panzoomMermaid(id: string): void {
    const container = document.getElementById(id)?.parentElement;
    if (!container) return;
    const svgElement = container.querySelector("svg");
    if (!svgElement) return;

    // Initialize Panzoom
    const panzoomInstance = Panzoom(svgElement, {
      maxScale: 5,
      minScale: 0.5,
      step: 0.1,
    });

    // Add mouse wheel zoom
    container.addEventListener("wheel", panzoomInstance.zoomWithWheel);
  }

  function initMermaid(): void {
    mermaid.initialize({
      startOnLoad: true,
      theme: "default",
      securityLevel: "loose",
      fontFamily: "Inter, system-ui, sans-serif",
      flowchart: {
        htmlLabels: false,
      },
    });

    // Re-render on theme change
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === "class") {
          mermaid.initialize({
            theme: "default",
          });
          mermaid.run({
            querySelector: `.mermaid`,
            postRenderCallback: panzoomMermaid,
          });
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });

    mermaid.run({
      querySelector: `.mermaid`,
      postRenderCallback: panzoomMermaid,
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initMermaid);
  } else {
    initMermaid();
  }

  document.addEventListener("astro:after-swap", initMermaid);
</script>

<style>
  .mermaid-wrapper,
  .mermaid-wrapper *,
  .mermaid,
  .mermaid * {
    font-variant-ligatures: none !important;
    font-feature-settings:
      "liga" off,
      "calt" off !important;
  }

  .mermaid {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  .mermaid svg {
    max-width: 100%;
    height: auto;
  }
</style>
