---
// Server-side Mermaid diagram component - renders at build time
import { renderMermaidToSVG } from "@/lib/mermaid-renderer";

interface Props {
  code: string;
}

const { code } = Astro.props;

// Trim and normalize the code
const normalizedCode = code.trim();

const id = `mermaid-${Math.random().toString(36).substr(2, 9)}`;

// Render Mermaid to SVG at build time
const svg = await renderMermaidToSVG(normalizedCode);
---

<div class="mermaid-wrapper not-prose my-8">
  <div class="mermaid-container rounded-lg border bg-card p-2">
    <div id={id} class="mermaid-svg-wrapper" set:html={svg} />
  </div>
</div>

<script>
  import Panzoom from "@panzoom/panzoom";

  // Enable pan and zoom for Mermaid diagrams
  function panzoomMermaid(id: string): void {
    const container = document.getElementById(id)?.parentElement;
    if (!container) return;
    const svgElement = container.querySelector("svg");
    if (!svgElement) return;

    // Initialize Panzoom
    const panzoomInstance = Panzoom(svgElement, {
      maxScale: 5,
      minScale: 0.5,
      step: 0.1,
    });

    // Add mouse wheel zoom
    container.addEventListener("wheel", panzoomInstance.zoomWithWheel);
  }
  
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".mermaid-svg-wrapper").forEach((element) => {
      panzoomMermaid(element.id);
    });
  });
</script>

<style>
  .mermaid-wrapper,
  .mermaid-wrapper * {
    font-variant-ligatures: none !important;
    font-feature-settings:
      "liga" off,
      "calt" off !important;
  }

  .mermaid-svg-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  .mermaid-svg-wrapper :global(svg) {
    max-width: 100%;
    height: auto;
  }
</style>
